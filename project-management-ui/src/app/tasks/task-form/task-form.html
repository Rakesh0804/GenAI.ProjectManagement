<div class="task-form-container">
  <div class="form-header">
    <h2>{{ getFormTitle() }}</h2>
    <button mat-icon-button (click)="onCancel()" *ngIf="dialogRef">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
    
    <!-- Task Number Display (for edit mode only) -->
    <div class="form-row" *ngIf="isEditMode && task?.taskNumber">
      <div class="task-number-display">
        <mat-icon>tag</mat-icon>
        <span class="task-number-label">Task Number:</span>
        <span class="task-number-value">{{ task?.taskNumber }}</span>
      </div>
    </div>
    
    <div class="form-row">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Task Title</mat-label>
        <input matInput formControlName="title" placeholder="Enter task title" required>
        <mat-error *ngIf="taskForm.get('title')?.hasError('required')">
          Task title is required
        </mat-error>
        <mat-error *ngIf="taskForm.get('title')?.hasError('maxlength')">
          Task title must be less than 200 characters
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" placeholder="Enter task description" rows="3"></textarea>
        <mat-error *ngIf="taskForm.get('description')?.hasError('maxlength')">
          Description must be less than 1000 characters
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row two-columns">
      <mat-form-field appearance="outline">
        <mat-label>Project</mat-label>
        <input type="text" 
               matInput 
               formControlName="projectId"
               [matAutocomplete]="projectAuto"
               placeholder="Type to search projects..."
               required>
        <mat-autocomplete #projectAuto="matAutocomplete" [displayWith]="displayProjectFn">
          <mat-option *ngFor="let project of (filteredProjects | async) || []" [value]="project">
            <span>{{ project.name }}</span>
            <small> - {{ project.clientName }}</small>
          </mat-option>
          <mat-option *ngIf="projects.length === 0" disabled>
            <span>Loading projects...</span>
          </mat-option>
          <mat-option *ngIf="projects.length > 0 && (filteredProjects | async)?.length === 0" disabled>
            <span>No projects found</span>
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="taskForm.get('projectId')?.hasError('required')">
          Project is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Task Type</mat-label>
        <mat-select formControlName="acronym" required>
          <mat-option *ngFor="let taskType of taskTypes" [value]="taskType.value">
            <div class="task-type-option">
              <div class="task-type-header">
                <span class="task-type-label">{{ taskType.label }}</span>
                <span class="task-type-code" [style.background-color]="taskType.color + '20'" [style.color]="taskType.color">
                  {{ taskType.value }}
                </span>
              </div>
              <div class="task-type-description">{{ taskType.description }}</div>
            </div>
          </mat-option>
        </mat-select>
        <mat-hint *ngIf="!isEditMode">Select the type of task you're creating</mat-hint>
        <mat-hint *ngIf="isEditMode">Task type cannot be changed for existing tasks</mat-hint>
        <mat-error *ngIf="taskForm.get('acronym')?.hasError('required') && !isEditMode">
          Task type is required
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row two-columns">
      <mat-form-field appearance="outline">
        <mat-label>Assigned To</mat-label>
        <input type="text" 
               matInput 
               formControlName="assignedUserId"
               [matAutocomplete]="userAuto"
               placeholder="Type to search users...">
        <mat-autocomplete #userAuto="matAutocomplete" [displayWith]="displayUserFn">
          <mat-option value="" class="unassigned-option">
            <mat-icon>person_outline</mat-icon>
            <span>Unassigned</span>
          </mat-option>
          <mat-option *ngFor="let user of (filteredUsers | async) || []" [value]="user" class="user-option">
            <mat-icon>person</mat-icon>
            <span>{{ user.firstName }} {{ user.lastName }}</span>
            <small> - {{ user.email }}</small>
          </mat-option>
          <mat-option *ngIf="users.length === 0" disabled>
            <span>Loading users...</span>
          </mat-option>
          <mat-option *ngIf="users.length > 0 && (filteredUsers | async)?.length === 0" disabled>
            <span>No users found</span>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status" required>
          <mat-option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="taskForm.get('status')?.hasError('required')">
          Status is required
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row two-columns">
      <mat-form-field appearance="outline">
        <mat-label>Priority</mat-label>
        <mat-select formControlName="priority" required>
          <mat-option *ngFor="let priority of priorityOptions" [value]="priority.value">
            {{ priority.label }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="taskForm.get('priority')?.hasError('required')">
          Priority is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Due Date</mat-label>
        <input matInput type="date" formControlName="dueDate">
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Estimated Hours</mat-label>
        <input matInput type="number" formControlName="estimatedHours" min="0" step="0.5">
        <mat-error *ngIf="taskForm.get('estimatedHours')?.hasError('min')">
          Estimated hours must be a positive number
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-actions">
      <button mat-button type="button" (click)="onCancel()" [disabled]="isLoading">
        Cancel
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || taskForm.invalid">
        <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
        <span *ngIf="!isLoading">{{ getSubmitButtonText() }}</span>
      </button>
    </div>

  </form>
</div>
